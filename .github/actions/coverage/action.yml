name: "Test and coverage check"
description: "Test and coverage check with gcovr, pass if coverage is greater than 20%"

runs:
  using: "composite"
  steps:
    - name: "Run coverage"
      shell: bash
      run: |
          PROJECT_PATH=$(pwd)

          # ToDo: Add documentation and describe better this command
          ctest --test-dir build/tests --output-on-failure

          # ToDo: Add documentation and describe better this command
          gcovr -r $PROJECT_PATH $PROJECT_PATH/build > $PROJECT_PATH/coverage.txt

          cat $PROJECT_PATH/coverage.txt

          # Find the value of correct coverage
          # ToDo: Add documentation and describe better this command
          linesCoverage=$(cat $PROJECT_PATH/coverage.txt | grep -oP 'TOTAL.*\K\d+\.\d+')

          # Check if the coverage is greater than 20%
          if (( $(echo "$linesCoverage > 20" | bc -l) )); then
              echo "Coverage is greater than 20%. Niiiceee"
              exit 0
          else
              echo "Error: Coverage is less than 20%"
              exit 1
          fi
    # Upload errors as an artifact, when failed
    - uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: Tests or coverage errors!!!
        path: $(pwd)/error_flag.txt
        retention-days: 1
